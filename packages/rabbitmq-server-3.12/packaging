set -e

# Extract RabbitMQ
tar -xf rabbitmq/rabbitmq-server-3.12.12.tar.xz

# Move RabbitMQ to the BOSH install directory
mv rabbitmq_server-3.12.12 ${BOSH_INSTALL_TARGET}/rabbitmq

rabbitmq-server-3.12/rabbitmq-server-generic-unix-3.12.12.tar.xz

set -e

RMQ_VERSION="3.12.12"
RMQ_VERSION_SEMVER="3.12.12"
RABBITMQ_SERVER_PATH="rabbitmq-server-3.12"

echo "$RMQ_VERSION_SEMVER" > "$BOSH_INSTALL_TARGET/rmq_version"

tar xf "${RABBITMQ_SERVER_PATH}/rabbitmq-server-generic-unix-$RMQ_VERSION.tar.xz"

cp -a "rabbitmq_server-$RMQ_VERSION"/* "$BOSH_INSTALL_TARGET"

mv "$BOSH_INSTALL_TARGET/sbin" "$BOSH_INSTALL_TARGET/privbin"

mkdir "$BOSH_INSTALL_TARGET/bin"
for script in rabbitmqctl rabbitmq-server rabbitmq-plugins rabbitmq-diagnostics rabbitmq-upgrade
do
    cp rabbitmq-server/rabbitmq-script-wrapper "$BOSH_INSTALL_TARGET/bin/$script"
    chmod 0755 "$BOSH_INSTALL_TARGET/bin/$script"
done

cp -a rabbitmq-server/rabbitmq-defaults "$BOSH_INSTALL_TARGET/privbin/"

